---
title: "weather"
author: "seok"
date: "2018년 6월 9일"
output:
  html_document:
    number_sections: yes
    toc: yes
    toc_depth: 3
    toc_float: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# 날씨 데이터를 이용한 회귀분석
## 로지스틱 회귀분석
### 로지스틱 회귀분석이란
 - 종속변수와 독립변수 간의 관계를 나타내어 예측 모델을 생성한다는 점에서 선형회귀분석과 동일
 - 독립변수(x)에 의해서 종속변수(y)의 범주로 분류한다는 측면은 분류분석 방법으로 분류된다.

### 로지스틱 회귀분석의 특징
 - 분석 목적 : 종속변수와 독립변수 간의 관계를 통해서 예측 모델을 생성하는 데 있다.
 - 회귀분석과 차이점: 종속변수는 반드시 범주형 변수이어야 한다.
 - 정규성: 정규분대신에 이항분포를 따른다.
 - 로짓 변환 : 종속변수의 출력범위를 0과 1로 조정하는 과정을 의미
 - 활용 분야 : 의료, 통신, 날씨 등 다양한 분야에서 활용

```{r}
weather = read.csv("../data/weather.csv", stringsAsFactors = F)
# 데이터 확인
weather
```

## 날씨 데이터 분석

### 데이터 가져오기
```{r}
attributes(weather) # 변수 속성 보기

summary(weather) # 데이터 요약 보기

dim(weather) # 데이터 객체의 차원보기

head(weather) # 상위 6개 관측치 미리보기

tail(weather) # 하위 6개 관측치 미리보기

str(weather) # 데이터 구조, 변수 개수, 변수 명, 관찰치 개수, 관찰치의 미리보기

length(weather$Date) # 데이터 객체의 요소들의 개수

names(weather) # 데이터 객체 구성요소 이름

class(weather) # 데이터 객체 구성요소의 속성

```

 - 날씨 관련 변수에 따라서 비가 내릴지의 여부를 기록한 데이터
 - 이 데이터를 분석하여 어떤 날씨 조건에 비가 내릴지 또는 내리지 않을지에 대한 판단 기준을 분석할 수 있다.
 - Date(측정날짜), MinTemp(최저기온), MaxTemp(최고기온), Rainfall(강수량), Sunshine(햇빛)
 - WindGustDir(돌풍방향), WidGustSpeed(돌풍 속도), WindDir(바람 방향), WindSpeed(바람 속도)
 - Humidity(습도), Pressure(기압), Cloud(구름), Temp(온도), RainToday(금일 비 여부), RainTomorrow(내일 비 여부)

### 데이터 전처리 
 - 날씨 데이터의 분석을 위해 x, y 변수를 결정
 - y(독립변수) 변수를 대상으로 로짓 변환하여 로지스틱 회귀분석을 위한 환경을 마련
 
#### 결측치 확인
```{r}
sum(is.na(weather)) # 전체 결측치 갯수 확인
sum(is.na(weather$Sunshine)) # Sunshine 컬럼의 결측치 갯수 확인
sum(is.na(weather$WindGustDir)) # WindGustDir 컬럼의 결측치 갯수 확인
sum(is.na(weather$WindGustSpeed)) # WindGustSpeed 컬럼의 결측치 갯수 확인
sum(is.na(weather$WindDir)) # WindDir 컬럼의 결측치 갯수 확인

colSums(is.na(weather)) # 한번에 결측값 현황 파악하는 방법
```

#### 데이터 변환
```{r}
weather_df <- weather[, c(-1, -6, -8, -14)] # chr 데이터 타입 컬럼, Date, RainToday 컬럼 제거

str(weather_df) # 컬럼 삭제 후 확인

weather_df$RainTomorrow[weather_df$RainTomorrow=="Yes"] <- 1 # Yes -> 1
weather_df$RainTomorrow[weather_df$RainTomorrow=="No"] <- 0 # Tes -> 0
weather_df$RainTomorrow <- as.numeric(weather_df$RainTomorrow) # 수정한 값을 numeric으로 형변환
```

#### 데이터 확인
```{r}
head(weather_df)
```

### 학습 데이터와 검정 데이터 생성 (7:3 비율)
```{r}
# 던순 임의 추출
idx <- sample(1:nrow(weather_df), nrow(weather_df) * 0.7) # 70%의 데이터만을 training 데이터로  사
train <- weather_df[idx, ]
# train <- na.omit(train)
test <- weather_df[-idx, ]
# colSums(is.na(train))
```

### 로지스틱 회귀모델 생성
```{r}
# generalized linear model
# glm(y ~ x, data, family)
# family의 'binomial'은 y 변수가 이항형인 경우 지정하는 속성 값
weather_model <- glm(RainTomorrow ~ ., data=train, family="binomial")
weather_model
summary(weather_model)
```

### 로지스틱 회귀모델 예측치 생성
```{r}
# newdata=test : 새로운 데이터 셋, type="response" : 0~1 확률값으로 예측 
pred <- predict(weather_model, newdata=test, type="response")
pred
summary(pred)
str(pred)
# 예측치 : 0과 1로 변환(0.5 기준)
result_pred <- ifelse(pred >= 0.5, 1, 0)
result_pred
# table(data.frame)
table(result_pred)
```
 - 모델을 평가하기 위해서는 혼돈 매트릭스를 이용한다.
 - 예측치가 확률 값으로 제공되기 때문에 이를 이항형으로 변환하는 과정이 필요하다.
 - ifelse() 함수를 이용하여 예측치의 vector변수(pred)를 입력으로 이항형의 vector 변수(result_pred)를 생성

### 모델 평가: 분류정확도 계산
```{r}
table(result_pred, test$RainTomorrow)

## result_pred  0  1
##           0 83 13
##           1  1 12
(88 + 9) / nrow(test)
```
 - 모델의 예측치와 검정데이터의 y 변수를 이용하여 혼돈 매트릭스를 생성
 - 이를 토대로 모델의 분류정확도를 계산할 수 있다.
 
### ROC Curve를 이용한 모델 평가
```{r}
# Receiver Operating Characteristic
# install.packages("ROCR")
library(ROCR)
# ROCR 패키지 제공 함수 : prediction() -> performance
#
pr <- prediction(pred, test$RainTomorrow)
prf <- performance(pr, measure = "tpr", x.measure = "fpr")
plot(prf)
```

 - ROC 곡선에서 왼쪽 상단의 계단 모양의 빈공백만큼이 분류정확도에서 오분류(missing)를 나타낸다.
 
# 날씨 데이터를 이용한 비 유무 예측
## rpart()를 이용한 분류 분석
```{r}
# install.packages("rpart")
library(rpart)
```
### 데이터 특성 보기
```{r}
str(weather)
names(weather)
```
### 분류분석 - 의사결정트리 생성
```{r}
# RainTomorrow 컬럼을 y변수로 지정
# 날씨 요인과 관련이 없는 Data와 RainToday 컬럼을 제외한 나머지 변수를 x 변수로 지정하여 분류모델을 수행
# rpart(반응변수 ~ 설명변수, data)
weather.df <- rpart(RainTomorrow ~., data=weather[, c(-1, -14)], cp=0.01)

```

### 분류분석의 시각화

```{r}
X11() # 차트를 띄울 별도의 창 생성
plot(weather.df) # 트리 프레임 보임
text(weather.df, use.n = T, cex=0.7) # 텍스트 추가
post(weather.df, file="") # 타원제공 - rpart 패키지 제공 
```

 - Humidity >= 71.5일 때 RainTomorrow는 Yes:20, No:7
 - Humidity < 71.5 이고 WindGustSpeed >= 64이면 RainTomorrow는 Yes:12, No:6
 - 분기 조건의 참일 때 왼쪽, 거짓일 때 오른쪽으로 분류
 - rpart() 함수의 cp 속성값을 높이면 가지수가 적어지고, 낮추면 가지 수가 많아진다.
 - cp의 기본 값은 0.01
 
### 예측치 생성과 코딩 변경

#### 예측치 생성
```{r}
weather_pred <- predict(weather.df, weather)
head(weather_pred)
```

#### y의 범주로 코딩 변환 : Yes(0.5이상), No(0.5 미만)
```{r}
weather_pred2 <- ifelse(weather_pred[,2] >= 0.5, 'Yes', 'No' )
```
 
 - rpart의 분류모델의 예측치는 비 유무를 0 ~ 1 사이의 확률값으로 예측한다.
 - 따라서 0.5 이상이면 비가 오는 경우로, 0.5 미만이면 비가 오지 않는 경우로 범주화하여 코딩 변경해야 혼돈 매트릭스를 이용하여 분류정확도를 구할 수 있다.
 
### 모델 평가
```{r}
table(weather_pred2, weather$RainTomorrow)
(278 + 53) / nrow(weather)
```